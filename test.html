<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tất cả người chơi - Lịch sử điểm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="data.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="tournament.css">
</head>

<body class="bg-gray-100 font-sans">

    <nav class="bg-blue-800 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">NineBall</h1>
            <div class="space-x-4">
                <a href="rankings.html" class="hover:underline">Rankings</a>
                <a href="tournaments.html" class="hover:underline">Tournaments</a>
                <a href="match_history.html" class="hover:underline">Match History</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4">
        <h2 class="text-2xl font-bold mb-4">Biểu đồ lịch sử điểm của tất cả người chơi</h2>
        <div class="bg-white p-4 rounded shadow">
            <canvas id="all-players-chart" width="1000" height="500"></canvas>
        </div>
    </main>

    <footer class="bg-blue-800 text-white p-4 text-center">
        © 2025 NineBall. All rights reserved.
    </footer>

    <script>
        function parseVNDate(str) {
            let [day, month, year] = str.split('/').map(Number);
            return new Date(year, month - 1, day);
        }

        function toVNString(date) {
            return date.toLocaleDateString('vi-VN');
        }

        function getRandomColor() {
            const r = Math.floor(Math.random() * 200);
            const g = Math.floor(Math.random() * 200);
            const b = Math.floor(Math.random() * 200);
            return `rgb(${r}, ${g}, ${b})`;
        }

        async function renderAllPlayersChart() {
            await initializePoolData();

            // Tìm ngày nhỏ nhất & lớn nhất
            const allDatesInHistory = poolData.history_point
                .filter(h => h.date)
                .map(h => parseVNDate(h.date));

            const minDateOverall = parseVNDate("29/07/2025");
            const endDate = new Date();

            // Tạo labels nhưng bỏ bớt ngày không biến động
            let labels = [];
            let stagnantCount = 0;

            let currentDate = new Date(minDateOverall);
            while (currentDate <= endDate) {
                const dateStr = toVNString(currentDate);

                // Kiểm tra xem ngày này có ai nhận điểm không
                const hasChange = poolData.history_point.some(h => h.date === dateStr && h.point !== 0);

                if (hasChange) {
                    stagnantCount = 0;
                    labels.push(dateStr);
                } else {
                    stagnantCount++;
                    // Chỉ giữ tối đa 2 ngày liên tiếp không biến động
                    if (stagnantCount <= 2) {
                        labels.push(dateStr);
                    }
                }

                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Dataset cho mỗi người
            const datasets = poolData.players
                .filter(player => player.name !== "Chấm")
                .map(player => {
                    const playerHistory = poolData.history_point
                        .filter(h => h.playerId == player.id && h.date)
                        .sort((a, b) => parseVNDate(a.date) - parseVNDate(b.date));

                    if (playerHistory.length === 0) return null;

                    // Start date = 1 ngày trước khi có điểm đầu tiên
                    const firstDate = parseVNDate(playerHistory[0].date);
                    firstDate.setDate(firstDate.getDate() - 1);

                    let cumulative = 0;
                    const dataPoints = labels.map(date => {
                        const dateObj = parseVNDate(date);
                        if (dateObj < firstDate) return null;

                        const pointsOnDate = playerHistory
                            .filter(h => h.date === date)
                            .reduce((sum, h) => sum + h.point, 0);
                        cumulative += pointsOnDate;
                        return cumulative;
                    });

                    return {
                        label: player.name,
                        data: dataPoints,
                        borderColor: getRandomColor(),
                        spanGaps: true,
                        fill: false
                    };
                })
                .filter(dataset => dataset !== null);

            // Vẽ Chart.js
            const ctx = document.getElementById('all-players-chart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                plugins: {
                    legend: { position: 'bottom' },
                    title: {
                        display: true,
                        text: 'Điểm tích lũy theo ngày của tất cả người chơi'
                    }
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true },
                        x: {
                            ticks: {
                                // Giảm số lượng label trên trục x để tránh chồng chéo
                                maxTicksLimit: 10,

                            }
                        }
                    }
                }
            });
        }

        renderAllPlayersChart();
    </script>
</body>

</html>