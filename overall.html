<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overall</title>
    <link rel="icon" type="image/png" href="images/icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="data.js"></script>
    <link rel="stylesheet" href="overall.css">
    <link rel="stylesheet" href="style.css">
</head>

<body class="bg-gray-100 font-sans">
    <nav id="header" class="bg-blue-900 text-white p-4 hidden">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">NineBall</h1>
            <ul class="flex space-x-6">
                <li><a href="overall.html" class="hover:text-blue-300 font-bold">Overall</a></li>
                <li><a href="rankings.html" class="hover:text-blue-300">Rankings</a></li>
                <li><a href="tournaments.html" class="hover:text-blue-300">Tournaments</a></li>
                <li><a href="match_history.html" class="hover:text-blue-300">History</a></li>
            </ul>
        </div>
    </nav>
    <!-- Header -->
    <button id="skip-btn"
        class="absolute top-4 right-4 bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-white font-semibold z-50">
        Bỏ qua
    </button>
    <main id="chart" class="container mx-auto p-4 hidden">
        <h2 class="text-2xl font-bold mb-4">Biểu đồ lịch sử điểm của tất cả người chơi</h2>
        <div class="bg-white p-4 rounded shadow">
            <canvas id="all-players-chart" width="1000" height="500"></canvas>
        </div>
    </main>
    <!-- Showcase -->
    <main id="main-wrap" class="flex items-center justify-center h-screen p-4">
        <section id="slideshow"
            class="card relative w-full max-w-4xl aspect-video rounded-2xl shadow-lg bg-white flex items-center justify-center overflow-hidden">
            <div class="ring" aria-hidden="true"></div>
            <div id="stage" class="text-center p-6 w-full"></div>
        </section>
    </main>

    <!-- <script src="app.js"></script> -->
    <!-- <script src="data.js"></script> -->
    <script>
        function parseVNDate(str) {
            let [day, month, year] = str.split('/').map(Number);
            return new Date(year, month - 1, day);
        }

        function toVNString(date) {
            return date.toLocaleDateString('vi-VN');
        }

        function getRandomColor() {
            const r = Math.floor(Math.random() * 200);
            const g = Math.floor(Math.random() * 200);
            const b = Math.floor(Math.random() * 200);
            return `rgb(${r}, ${g}, ${b})`;
        }

        async function renderAllPlayersChart() {
            await initializePoolData();

            // Tìm ngày nhỏ nhất & lớn nhất
            const allDatesInHistory = poolData.history_point
                .filter(h => h.date)
                .map(h => parseVNDate(h.date));

            const minDateOverall = parseVNDate("29/07/2025");
            const endDate = new Date();

            // Tạo labels nhưng bỏ bớt ngày không biến động
            let labels = [];
            let stagnantCount = 0;

            let currentDate = new Date(minDateOverall);
            while (currentDate <= endDate) {
                const dateStr = toVNString(currentDate);

                // Kiểm tra xem ngày này có ai nhận điểm không
                const hasChange = poolData.history_point.some(h => h.date === dateStr && h.point !== 0);

                if (hasChange) {
                    stagnantCount = 0;
                    labels.push(dateStr);
                } else {
                    stagnantCount++;
                    // Chỉ giữ tối đa 2 ngày liên tiếp không biến động
                    if (stagnantCount <= 2) {
                        labels.push(dateStr);
                    }
                }

                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Dataset cho mỗi người
            const datasets = poolData.players
                .filter(player => player.name !== "Chấm")
                .filter(player => !player.name.includes("Khách"))
                .map(player => {
                    const playerHistory = poolData.history_point
                        .filter(h => h.playerId == player.id && h.date)
                        .sort((a, b) => parseVNDate(a.date) - parseVNDate(b.date));

                    if (playerHistory.length === 0) return null;

                    // Start date = 1 ngày trước khi có điểm đầu tiên
                    const firstDate = parseVNDate(playerHistory[0].date);
                    firstDate.setDate(firstDate.getDate() - 1);

                    let cumulative = 0;
                    const dataPoints = labels.map(date => {
                        const dateObj = parseVNDate(date);
                        if (dateObj < firstDate) return null;

                        const pointsOnDate = playerHistory
                            .filter(h => h.date === date)
                            .reduce((sum, h) => sum + h.point, 0);
                        cumulative += pointsOnDate;
                        return cumulative;
                    });

                    return {
                        label: player.name,
                        data: dataPoints,
                        borderColor: getRandomColor(),
                        spanGaps: true,
                        fill: false
                    };
                })
                .filter(dataset => dataset !== null);

            // Vẽ Chart.js
            const ctx = document.getElementById('all-players-chart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                plugins: {
                    legend: { position: 'bottom' },
                    title: {
                        display: true,
                        text: 'Điểm tích lũy theo ngày của tất cả người chơi'
                    }
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true },
                        x: {
                            ticks: {
                                // Giảm số lượng label trên trục x để tránh chồng chéo
                                maxTicksLimit: 10,

                            }
                        }
                    }
                }
            });
        }

        renderAllPlayersChart();
    </script>
    <script src="app1.js"></script>
    <script src="app2.js"></script>
</body>

</html>